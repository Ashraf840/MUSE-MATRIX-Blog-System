<!DOCTYPE html>
<html lang="en">
{% load static %}

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        {% block title %} {% endblock %}
    </title>

    <!-- TailwindCSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Font Awesome Icons -->
    <script src="https://kit.fontawesome.com/272e010829.js" crossorigin="anonymous"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />

    <link id="pagestyle" href="{% static 'css/output/newsletter/newsletterPage.css' %}" rel="stylesheet" />

    <!-- Add sweet alert 2 pop-up message script -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

</head>

<body>

    <div class="flex flex-col h-screen justify-between">
        <!-- HEADER -->
        <header class="bg-gray-200">
            <div
                class="xl:container xl:mx-auto flex flex-col items-center text-center sm:flex-row sm:justify-between py-3">
                <div
                    class="gf-nav-search-input-field-wrapper px-8 w-96 order-2 sm:order-1 flex justify-center py-4 sm:py-0">
                    <input type="text" class="gf-nav-search-input-field search-input-field" placeholder="Search..." />
                </div>
                <div class="shirnk w-11/12 sm:order-2 py-4">
                    <a href="{% url 'HomepageApplication' %}" class="gf-nav-title font-bold uppercase text-4xl">Muse
                        Matrix</a>
                </div>
                <div class="gf-nav-socials w-96 order-3 flex justify-center">
                    <div class="flex gap-6">
                        <a><i class="fa-brands fa-facebook"></i></a>
                        <a><i class="fa-brands fa-square-x-twitter"></i></a>
                        <a><i class="fa-brands fa-square-instagram"></i></a>
                    </div>
                </div>
            </div>
        </header>
        <main class="mb-auto">
            <section class="container">
                <div class="flex justify-center">

                    <!-- Post -->
                    <div class="newsletter">
                        <h1 class="newsletter-title">
                            Newsletter
                        </h1>

                        <div class="newsletter-list-body">

                            <div class="relative overflow-x-auto shadow-md sm:rounded-lg">
                                <table class="w-full text-sm text-left rtl:text-right text-gray-500 dark:text-gray-400">
                                    <thead class="text-xs text-gray-700 uppercase bg-gray-300">
                                        <tr>
                                            <!-- <th scope="col" class="p-4">
                                                <div class="flex items-center">
                                                    <input id="checkbox-all-search" type="checkbox"
                                                        class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 dark:focus:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600">
                                                    <label for="checkbox-all-search" class="sr-only">checkbox</label>
                                                </div>
                                            </th> -->
                                            <th colspan="3" scope="col" class="text-center px-6 py-3 bg-teal-200">
                                                <button type="button" class="open-modal-btn py-2.5 px-5 me-2 mb-2 text-sm font-medium text-gray-500 
                                                    focus:outline-none bg-white rounded-lg border border-gray-200 
                                                    hover:bg-gray-100 hover:text-gray-900 focus:z-10 
                                                    focus:ring-4 focus:ring-gray-100" onclick="openModal()">
                                                    Send Email
                                                </button>
                                            </th>
                                            <!-- <th scope="col" class="ps-28 pe-6 py-3">
                                                Action
                                            </th> -->
                                        </tr>
                                    </thead>
                                    <thead class="text-xs text-gray-700 uppercase bg-gray-300">
                                        <tr>
                                            <th scope="col" class="p-4">
                                                <div class="flex items-center">
                                                    <input id="checkbox-all-search" type="checkbox"
                                                        onchange="selectAllCheckbox()"
                                                        class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 dark:focus:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600">
                                                    <label for="checkbox-all-search" class="sr-only">checkbox</label>
                                                </div>
                                            </th>
                                            <th scope="col" class="px-6 py-3">
                                                Email
                                            </th>
                                            <!-- <th scope="col" class="ps-28 pe-6 py-3">
                                                Action
                                            </th> -->
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for s_email in subscribed_emails %}
                                        <!-- 1st -->
                                        <tr class="bg-white border-b hover:bg-gray-50">
                                            <td class="w-4 p-4">
                                                <div class="flex items-center">
                                                    <input id="checkbox-{{ s_email.id }}" type="checkbox"
                                                        value="{{ s_email.email }}"
                                                        onchange="appendRemoveEmailChecklist('{{ s_email.id }}', '{{ s_email.email }}')"
                                                        class="checkbox w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 dark:focus:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600">
                                                </div>
                                            </td>
                                            <th scope="row"
                                                onclick="emailDivHandler('{{ s_email.id }}', '{{ s_email.email }}')"
                                                class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap cursor-pointer">
                                                {{ s_email.email }}
                                            </th>
                                            <!-- <td class="flex items-center ps-28 pe-6 py-4">
                                                <button type="button" id="open-modal-btn"
                                                    onclick="openModal('{{ s_email.id }}')"
                                                    class="open-modal-btn-{{s_email.id}} py-2.5 px-5 me-2 mb-2 text-sm font-medium text-gray-500 focus:outline-none bg-white rounded-lg border border-gray-200 hover:bg-gray-100 hover:text-gray-900 focus:z-10 focus:ring-4 focus:ring-gray-100">
                                                    Send Email {{ s_email.id }}
                                                </button>
                                            </td> -->
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>

                        </div>

                        <!-- Newsletter Email Modal -->
                        <!-- class="overflow-y-auto overflow-x-hidden fixed top-0 right-0 bottom-0 left-0 flex items-center justify-center z-50"> -->
                        <div id="newsletter-email-modal" tabindex="-1" aria-hidden="true"
                            class="newsletter-email-modal hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 bottom-0 left-0 z-50">
                            <div class="relative p-4 w-full max-w-md">
                                <!-- Modal content -->
                                <div class="relative bg-white rounded-lg shadow dark:bg-gray-700">
                                    <!-- Modal header -->
                                    <div
                                        class="flex items-center justify-between p-4 md:p-5 border-b rounded-t dark:border-gray-600">
                                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
                                            Compose Email
                                        </h3>
                                        <button type="button" id="modal-close-btn"
                                            class="modal-close-btn text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 ms-auto inline-flex justify-center items-center dark:hover:bg-gray-600 dark:hover:text-white"
                                            data-modal-toggle="crud-modal">
                                            <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg"
                                                fill="none" viewBox="0 0 14 14">
                                                <path stroke="currentColor" stroke-linecap="round"
                                                    stroke-linejoin="round" stroke-width="2"
                                                    d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6" />
                                            </svg>
                                            <span class="sr-only">Close modal</span>
                                        </button>
                                    </div>
                                    <!-- Modal body -->
                                    <form class="p-4 md:p-5" method="POST">
                                        {% csrf_token %}
                                        <div class="grid gap-4 mb-4 grid-cols-2">
                                            <div class="col-span-2">
                                                <label for="recipient"
                                                    class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">To</label>
                                                <input type="email" name="recipient" id="recipient"
                                                    class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5 dark:bg-gray-600 dark:border-gray-500 dark:placeholder-gray-400 dark:text-white dark:focus:ring-primary-500 dark:focus:border-primary-500"
                                                    placeholder="Recipients" required="" multiple>
                                            </div>
                                            <div class="col-span-2">
                                                <label for="subject"
                                                    class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Subject</label>
                                                <input type="text" name="subject" id="subject"
                                                    class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5 dark:bg-gray-600 dark:border-gray-500 dark:placeholder-gray-400 dark:text-white dark:focus:ring-primary-500 dark:focus:border-primary-500"
                                                    placeholder="Subject" required="">
                                            </div>
                                            <div class="col-span-2">
                                                <label for="description"
                                                    class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">
                                                    Message
                                                </label>
                                                <textarea id="description" rows="4" name="email-body"
                                                    class="block p-2.5 w-full text-sm text-gray-900 bg-gray-50 rounded-lg border border-gray-300 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-600 dark:border-gray-500 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500"
                                                    placeholder="Write email here..."></textarea>
                                            </div>
                                        </div>
                                        <button type="submit"
                                            class="w-full text-white inline-flex items-center justify-center bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5">
                                            <i class="fa-solid fa-paper-plane mr-2"></i>
                                            <span class="text-center">Send</span>
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <!-- In this modified version, I've removed some unnecessary classes and modified the outer `<div>` to use flexbox (`flex items-center justify-center`) to center it both vertically and horizontally on the screen. -->

                        <!-- Additionally, I removed some unnecessary max-height and max-width properties, which were causing potential issues with centering. You might need to adjust the width and padding of the modal (`max-w-md` and `p-4` respectively) according to your design requirements. -->

                    </div>

            </section>
        </main>

        <!-- FOOTER -->
        <footer class="bg-gray-50">
            <section class="bg-gray-50 mt-5">
                <div class="container mx-auto md:px-20 py-16 text-center">
                    <!-- Empty Sapce -->
                </div>
            </section>
            <div class="container mx-auto flex justify-center py-12">
                <div class="py-5">
                    <div class="flex gap-6 justify-center">
                        <a><i class="fa-brands fa-facebook"></i></a>
                        <a><i class="fa-brands fa-square-x-twitter"></i></a>
                        <a><i class="fa-brands fa-square-instagram"></i></a>
                    </div>
                    <p class="copyright py-5 text-gray-400">Copyright @2024 All rights reserved | This tempalte is made
                        by
                        <b>nomadsde.com</b>
                    </p>
                    <p class="tc text-gray-400 text-center">Terms & Conditions</p>
                </div>
            </div>
        </footer>
    </div>

    <!-- Custom JS Script -->
    <script src="{% static 'js/newsletter/email-modal-toggle.js' %}"></script>

    <script>
        let selectedEmailList = [];
        let checkbox_all = document.querySelector(`#checkbox-all-search`);
        let checkboxes = document.querySelectorAll(".checkbox");
        let checkbox_checked_count_tracker = 0;

        // Show sweet alert message if email is sent successfully
        let email_send_status = `{{ email_send_status }}`
        if (email_send_status === "email-send-successful") {
            setTimeout(function () {
                Swal.fire({
                    position: "center",
                    icon: "success",
                    title: "Your work has been saved",
                    showConfirmButton: false,
                    timer: 1500
                });
            }, 600)
        }

        /**
         * Select/deselect all checkboxes at once including the select-all-checkbox by the select-all-checkbox itself.
         */
        function selectAllCheckbox() {
            if (checkbox_all.checked) {
                checkbox_checked_count_tracker = checkboxes.length;     // Assign the count-tracker to the length of all checkboxes, since all of them are checked
                // TODO: Check all the checkboxes & add all the emails to selected-email-list
                checkboxes.forEach(element => {
                    let checkbox = document.querySelector(`#${element.id}`);
                    checkbox.checked = true;
                    const checkbox_id = parseInt(`${element.id}`.match(/\d+/), 10);
                    appendRemoveEmailChecklist(checkbox_id, element.value);
                });
            } else {
                checkbox_checked_count_tracker = 0;     // Make the count-tracker to zero, since all the checkboxes are unchecked
                // TODO: Un-check all the checkboxes & remove all the emails from selected-email-list
                checkboxes.forEach(element => {
                    let checkbox = document.querySelector(`#${element.id}`);
                    checkbox.checked = false;
                    const checkbox_id = parseInt(`${element.id}`.match(/\d+/), 10);
                    appendRemoveEmailChecklist(checkbox_id, element.value);
                });
            }
            // console.log("checkbox_checked_count_tracker (selectAllCheckbox):", checkbox_checked_count_tracker);
            // console.log("selectedEmailList.length:", selectedEmailList.length);
        }

        /**
         * Checked each checkbox individually by clicking on the email names.
         */
        function emailDivHandler(checkbox_id, email) {
            let checkbox = document.querySelector(`#checkbox-${checkbox_id}`);
            if (!checkbox.checked) {
                checkbox.checked = true;
                appendRemoveEmailChecklist(checkbox_id, email);
            } else {
                checkbox.checked = false;
                appendRemoveEmailChecklist(checkbox_id, email);
            }
        }

        /**
         * Auto checked the select-all-checkbox after selecting all the unchecked checkbox
         */
        function dynamicallySelectAllCheckbox() {
            checkbox_checked_count_tracker += 1;    // Increase the count by one while checking every unchecked checkbox
            if (checkbox_checked_count_tracker === checkboxes.length) {
                checkbox_all.checked = true;
                console.log("Check select-all-checkbox");
            }
        }

        /**
         * Checked each checkbox individually by their specific checkbox-ids
         */
        function appendRemoveEmailChecklist(checkbox_id, email) {
            let checkbox = document.querySelector(`#checkbox-${checkbox_id}`);
            let email_lower = email.toLowerCase();

            // If the current checkbox gets checked, then append the passing email to the "selectedEmailList" list variable
            if (checkbox.checked) {
                // Add to selected-email-list [Duplicate check]
                if (selectedEmailList.length) {
                    // check for duplicate email before adding to selected-email-list
                    const matched = selectedEmailList.some(({ email }) => email === email_lower);
                    if (!matched) {
                        selectedEmailList.push({ 'email': email_lower });
                    }
                } else {
                    // add email to the array;
                    selectedEmailList.push({ 'email': email_lower });
                }

                // Check if select-all-checkbox is unchecked, so that it can be checked after all the checkboxes are checked individually by invoking this function
                if (!checkbox_all.checked) {
                    console.log("checkbox_checked_count_tracker (appendRemoveEmailChecklist):", checkbox_checked_count_tracker);
                    dynamicallySelectAllCheckbox();
                }
            }
            // If the current checkbox gets unchecked, then remove that passing email from the "selectedEmailList" list variable
            else {
                // Remove from selected-email-list by filtering the email-items from the passing email
                const filteredList = selectedEmailList.filter(item => item.email !== email_lower);
                selectedEmailList = filteredList
                // Check if the select-all-checkbox is checked, then uncheck this checkbox since one of the checkboxes from the table gets unchecked.
                // Scenario: User checked all the checkboxes, then uncheck certain checkbox(es). Similarly at the time of unchecking any checkbox, unckeck the select-all-checkbox also.
                if (checkbox_all.checked) {
                    checkbox_all.checked = false;
                }
                checkbox_checked_count_tracker -= 1;    // Decrease the count by one while unchecking every checked checkbox
            }
            console.log("selectedEmailList:", selectedEmailList);
        }
    </script>
</body>

</html>